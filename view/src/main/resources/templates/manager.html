<!DOCTYPE html>
<!--[if IE 7]> <html lang="en" class="ie7"> <![endif]-->
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->
<head>
    <title>VoteEase</title>
    <style>
        /* 分页控件样式 */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .pagination {
            display: flex;
            gap: 5px; /* 控制按钮之间的间距 */
        }

        .pagination .page-item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px 10px;
            background-color: transparent; /* 默认背景透明 */
            border: 1px solid #28a745; /* 绿色边框 */
            border-radius: 3px;
            transition: background-color 0.3s, color 0.3s;
        }

        .pagination .page-item.active {
            background-color: transparent; /* 激活状态下背景透明 */
            border-color: #28a745; /* 激活状态下保持绿色边框 */
            color: #28a745; /* 激活状态下文字颜色为绿色 */
            font-weight: bold; /* 加粗当前页码 */
        }

        .pagination .page-item:hover {
            background-color: #d1e7dd; /* 鼠标悬停时淡绿色背景 */
            cursor: pointer;
        }

        .pagination .page-item.disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .pagination .page-link {
            padding: 0;
            margin: 0;
            line-height: 1.5;
            color: #28a745; /* 默认状态下文字颜色为绿色 */
            text-decoration: none;
        }

        .pagination .page-link:hover {
            text-decoration: none;
        }

        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                align-items: stretch;
            }

            .pagination {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
    <script src="/js/axios.min.js"></script>
    <script src="/js/api.js"></script>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <!-- CSS Global Compulsory-->
    <link rel="stylesheet" href="/plugins/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/header.css" />
    <link rel="stylesheet" href="/plugins/bootstrap/css/bootstrap-responsive.min.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style_responsive.css" />
    <link rel="stylesheet" href="/css/zoom.css" media="all" type='text/css'  /> <!--图片弹出层样式 必要样式-->
    <!--     <link rel="shortcut icon" href="favicon.ico" />      -->
    <!-- CSS Implementing Plugins -->
    <link rel="stylesheet" href="/plugins/font-awesome/css/font-awesome.css" />
    <link href="/plugins/glyphicons/css/glyphicons.css" rel="stylesheet" />
    <!-- CSS pie chart -->
    <link rel="stylesheet" type="text/css" href="/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/css/postbutton.css" />
    <!-- CSS Theme -->
    <!--     <link rel="stylesheet" href="assets/css/themes/default.css" id="style_color" /> -->
    <!--     <link rel="stylesheet" href="assets/css/themes/headers/default.css" id="style_color-header-1" />   -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head>

<body>
<!--=== Top ===-->
<div class="top">
    <div id="status" class="container">
        <!-- Unauthenticated state -->
        <div id="unauthenticated" style="display: block;">
            <ul class="loginbar pull-right">
                <li><a href="/login" class="login-btn">Login</a></li>
                <li class="divider">&nbsp;</li>
                <li><a href="/register" class="login-btn">Register</a></li>
            </ul>
        </div>
        <!-- Authenticated state -->
        <div id="authenticated" style="display: none;">
            <ul class="loginbar pull-right">
                <li><a href="userCenter.html" class="login-btn" style="text-transform: none;">UserCenter</a></li>
                <li class="divider">&nbsp;</li>
                <li><a href="/messages" class="login-btn">Messages</a></li>
                <li class="divider">&nbsp;</li>
                <li><a href="#" id="logout-link" class="login-btn">Log out</a></li>
            </ul>
        </div>
    </div>
</div><!--/top-->
<!--=== End Top ===-->

<!--=== Header ===-->
<div class="header margin-bottom-20">
    <div class="container">

        <!-- Menu -->
        <div class="navbar">
            <div class="navbar-inner">
                <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>
                <div class="nav-collapse collapse" id="dynamic-nav">
                    <ul class="nav top-2" id="nav-links">
                        <!-- Home link will be inserted here dynamically -->
                    </ul>

                </div><!-- /nav-collapse -->
            </div><!-- /navbar-inner -->
        </div><!-- /navbar -->
    </div><!-- /container -->
</div><!--/header -->
<!--=== End Header ===-->

<!--=== Content Part ===-->
<div class="container">
    <div class="row-fluid">
        <div class="span10">
            <div class="headline"><h3>All Data</h3></div>
            <ul class="nav nav-tabs tabs" id="dataTabs">
                <li class="active"><a href="#polls" data-toggle="tab">All Polls</a></li>
                <li><a href="#users" data-toggle="tab">All Users</a></li>
            </ul><!--/tabs-->
            <div class="tab-content margin-bottom-20">
                <div class="tab-pane active" id="polls">
                    <!-- Accardion for Polls -->
                    <div class="accordion acc-home margin-bottom-40" id="pollAccordion"></div>
                    <!-- Pagination for Polls -->
                    <nav aria-label="Polls pagination" id="pollPagination" class="pagination-container"></nav>
                </div> <!--/tab-pane-->
                <div class="tab-pane" id="users">
                    <!-- List for Users -->
                    <div class="user-list" id="userList"></div>
                    <!-- Pagination for Users -->
                    <nav aria-label="Users pagination" id="userPagination" class="pagination-container"></nav>
                </div> <!--/tab-pane-->
            </div>
        </div><!--/span8-->
    </div><!--/row-fluid-->
</div><!--/container-->
<!--=== End Content Part ===-->

<!--=== Copyright ===-->
<div class="copyright">
    <div class="container">
        <div class="row-fluid">
            <div class="span8">
                <!-- start-copyright -->
                <p>Copyright @ 2024 Voteease</p>
                <!-- end-copyrigh -->
            </div>
            <div class="span4">
                <a href="mainpage.html"><img id="logo-footer" src="assets/img/htc_logo.png" class="pull-right" alt="" /></a>
            </div>
        </div><!--/row-fluid-->
    </div><!--/container-->
</div><!--/copyright-->
<!--=== End Copyright ===-->

<script type="module">
    // Function to check if the user is logged in based on the presence of an auth token.
    function isLoggedIn() {
        const token = localStorage.getItem('authToken');
        console.log('Checking login status:', !!token, 'Token:', token);
        return !!token && token.trim(); // Ensure the token is not just whitespace
    }

    // Function to toggle visibility of authentication states.
    function toggleAuthState() {
    console.log('Toggling authentication state...');
    const unauthenticatedDiv = document.getElementById('unauthenticated');
    const authenticatedDiv = document.getElementById('authenticated');

    if (isLoggedIn()) {
        console.log('User is logged in.');
        unauthenticatedDiv.style.display = 'none';
        authenticatedDiv.style.display = 'block';

        // Fetch user information and update the DOM elements accordingly.
        instance.get('/user/check')
            .then(response => {
                console.log('User info:', response.data);
                const userData = response.data.data;

                // Update the User Center link with the username.
                const userCenterLink = document.querySelector('#authenticated ul li a[href="userCenter.html"]');
                if (userCenterLink) {
                    userCenterLink.href = `/userCenter/${userData.username}`;
                    userCenterLink.textContent = `UserCenter`;
                }

                // Update the avatar image source if available.
                const avatarImg = document.querySelector('#authenticated img.media-object');
                if (avatarImg && userData.avatar) {
                    avatarImg.src = userData.avatar;
                }

                // Add Manager button if user is an admin.
                if (userData.isAdmin) {
                    const managerLi = document.createElement('li');

                    // Apply inline styles directly for spacing
                    managerLi.style.marginRight = '20px'; // Adjust the value as needed

                    managerLi.innerHTML = `<a href="/manager" class="login-btn">Manager</a>`;

                    // Find the UserCenter link and insert the new Manager button before it.
                    const userCenterLinkLi = document.querySelector('#authenticated ul li a[href^="/userCenter"]').parentElement;
                    if (userCenterLinkLi) {
                        userCenterLinkLi.parentElement.insertBefore(managerLi, userCenterLinkLi);
                    }
                }
            })
            .catch(error => {
                console.error('Error checking user info:', error);
            });
    } else {
        console.log('User is not logged in.');
        unauthenticatedDiv.style.display = 'block';
        authenticatedDiv.style.display = 'none';

        // Remove Manager button if it exists when user logs out.
        const managerButton = document.querySelector('#authenticated ul li a[href="/manager"]');
        if (managerButton) {
            managerButton.parentElement.remove();
        }
    }
}

    // Function to handle logout process.
    async function logout(event) {
        event.preventDefault(); // Prevent default link behavior.

        try {
            // Optionally, you can make a request to your server to invalidate the token.
            // await instance.post('/user/logout'); // Uncomment this line if needed.

            // Remove the token from local storage.
            localStorage.removeItem('authToken');
            console.log('User logged out.');

            // Toggle the authentication state display.
            toggleAuthState();

            // Optionally, you can redirect to a different page or refresh the current one.
            // window.location.reload(); // Uncomment this line if you want to reload the page.
        } catch (error) {
            console.error('Error during logout:', error);
        }
    }

    // Existing login function with added call to toggleAuthState upon successful login.
    async function login(event) {
        event.preventDefault(); // Prevent form's default submit behavior.

        try {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            await instance.post('/user/login', {
                email: email,
                password: password
            }).then(response => {
                if (response.data.code == 0) {
                    alert("success");
                    const token = response.data.data;
                    if (token) {
                        localStorage.setItem('authToken', token);
                        console.log('Token stored successfully:', token);

                        // Debugging: Check if token is being sent in headers
                        console.log('Authorization header:', { authorization: `Bearer ${token}` });

                        toggleAuthState(); // Update nav links after successful login.
                    } else {
                        console.warn('No token received from the server.');
                    }
                } else {
                    throw new Error('Login failed with code: ' + response.data.msg);
                }
            }).catch(error => {
                alert("error");
            });

        } catch (error) {
            console.error('Error during login:', error);
        }
    }

    // Add event listener for logout link
    document.addEventListener('DOMContentLoaded', () => {
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
            logoutLink.addEventListener('click', logout);
        }

        // Initialize the authentication state when the DOM is fully loaded.
        console.log('DOM fully loaded, initializing authentication state...');
        toggleAuthState();
    });

    // Listen for form submission.
    document.addEventListener('DOMContentLoaded', () => {
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', login);
        }
    });

    // Prevent double submission on "Log in" button click.
    document.addEventListener('DOMContentLoaded', () => {
        const submitButton = document.querySelector('.submit');
        if (submitButton) {
            submitButton.addEventListener('click', function(event) {
                login(event); // Call login function and pass event object.
            });
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Create the Home link and add it to the navigation bar
        const navLinks = document.getElementById('nav-links');
        const homeLi = document.createElement('li');
        const homeA = document.createElement('a');
        homeA.href = '/'; // URL for the home page
        homeA.textContent = 'Home';
        homeLi.appendChild(homeA);
        navLinks.appendChild(homeLi);

        fetch('/topic/all')
            .then(response => response.json())
            .then(data => {
                if (data.code === 0 && Array.isArray(data.data)) {
                    data.data.forEach(topic => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = `/topic/${topic.topicId}`; // New URL format using topicId
                        a.textContent = topic.name;
                        a.className = 'dropdown-toggle';
                        a.setAttribute('data-toggle', 'dropdown');
                        li.appendChild(a);
                        li.innerHTML += '<b class="caret-out"></b>';
                        navLinks.appendChild(li);
                    });

                    // After all topics are added, append the new <li> element
                    const searchLi = document.createElement('li');
                    searchLi.innerHTML = `<a class="search" href="/searchResult"><i class="icon-search search-btn"></i></a>`;
                    navLinks.appendChild(searchLi);
                }
            })
            .catch(error => console.error('Error fetching topics:', error));
    });
</script>


<script>
    (function() {
    'use strict';

    // 假设 instance 已经在其他地方声明并初始化
    if (typeof instance === 'undefined') {
        console.error('Instance is not defined. Please ensure it is properly initialized.');
        return;
    }

    let currentPagePolls = 1;
    let currentPageUsers = 1;
    const pageSize = 10;

    // 初始化页面时加载数据
    window.onload = function() {
        initializeTabs();
    };

    // 监听选项卡切换事件，确保点击时正确激活对应的选项卡并加载相应数据
    document.querySelectorAll('#dataTabs a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault(); // 阻止默认行为

            // 切换选项卡并更新激活状态
            const targetTabId = this.getAttribute('href');
            document.querySelectorAll('#dataTabs li').forEach(li => li.classList.remove('active'));
            this.parentElement.classList.add('active');

            // 显示对应的内容区，并隐藏其他内容区
            document.querySelectorAll('.tab-pane').forEach(tabPane => tabPane.classList.remove('active'));
            document.querySelector(targetTabId).classList.add('active');

            // 加载对应的数据
            if (targetTabId === '#polls') {
                loadPollData(currentPagePolls, pageSize);
            } else if (targetTabId === '#users') {
                loadUserData(currentPageUsers, pageSize);
            }
        });
    });

    function initializeTabs() {
        // 默认激活第一个选项卡
        document.querySelector('#dataTabs li:first-child a').click();
    }

    function getTotalPages(apiEndpoint, size, callback) {
        instance.get(`${apiEndpoint}/size?size=${size}`)
            .then(response => {
                const data = response.data;
                if (data.code === 0) { // 检查是否成功
                    callback(data.data); // 回调函数接收总页数
                } else {
                    console.error('Get total pages failed:', data.msg);
                    callback(1); // 如果获取失败，默认设为1页
                }
            })
            .catch(error => {
                console.error('Error:', error);
                callback(1); // 如果获取失败，默认设为1页
            });
    }

    function loadPollData(page, size) {
        getTotalPages('/poll/all', size, totalPages => {
            renderPagination('pollPagination', page, totalPages, loadPollData);
            fetchData(`/poll/all?page=${page}&size=${size}`, populatePollResults);
        });
    }

    function loadUserData(page, size) {
        getTotalPages('/user/all', size, totalPages => {
            renderPagination('userPagination', page, totalPages, loadUserData);
            fetchData(`/user/all?page=${page}&size=${size}`, populateUserResults);
        });
    }

    function fetchData(url, callback) {
        instance.get(url)
            .then(response => {
                const data = response.data;
                if (data.code === 0) { // 检查是否成功
                    callback(data.data);
                    console.log(data.data);
                } else {
                    console.error('Fetch data failed:', data.msg);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function populatePollResults(results) {
        const accordion = document.querySelector('#pollAccordion');
        accordion.innerHTML = ''; // 清空之前的搜索结果

        results.forEach(item => {
            const poll = item.poll || {}; // 确保poll对象存在
            const creator = item.creator || {};

            const group = document.createElement('div');
            group.className = 'accordion-group';

            const heading = `<div class="accordion-heading">
                                <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#pollAccordion" href="/commentpage/${poll.pollId}">
                                    ${poll.title || 'No Title'}
                                    <div style="float:right;font-size: 15px;margin-left:5px;">
                                        ${creator.username || 'Unknown'}
                                    </div>
                                    <img class="media-object" src="/static/avatar/${creator.avatar || 'default.png'}" alt="" style="width:18px; display:inline; float:right;" />
                                    <p>${poll.description ? poll.description.replace(/<[^>]+>/g, '') : 'No description available'}</p>
                                </a>
                                <button class="btn btn-sm btn-${poll.enabled ? 'danger' : 'success'} enable-button" data-id="${poll.pollId}" data-type="poll">${poll.enabled ? 'Enable' : 'Able'}</button>
                             </div>`;

            group.innerHTML = heading;
            accordion.appendChild(group);

            // 添加按钮点击事件
            const button = group.querySelector('.enable-button');
            button.addEventListener('click', () => toggleEnable('poll', poll.pollId, !poll.enable));
        });
    }

    function populateUserResults(users) {
        const userList = document.querySelector('#userList');
        userList.innerHTML = ''; // 清空之前的搜索结果

        users.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'user-item media'; // 使用media对象样式

            userItem.innerHTML = `
                <div class="media-left">
                    <a href="/userCenter/${encodeURIComponent(user.username)}">
                        <img class="avatar media-object" src="/static/avatar/${user.avatar || 'default.png'}" alt="Avatar" style="width: 64px; height: 64px; border-radius: 50%;" />
                    </a>
                </div>
                <div class="media-body">
                    <h4 class="media-heading">
                        <a href="/userCenter/${encodeURIComponent(user.username)}">${user.username || 'Unknown'}</a>
                    </h4>
                    <p>${user.email || 'Email not provided'}</p>
                    <p>${user.profile || 'No profile available'}</p>
                    <button class="btn btn-sm btn-${user.enabled ? 'danger' : 'success'} enable-button" data-id="${user.userId}" data-type="user">${user.enabled ? 'Enable' : 'Able'}</button>
                </div>
            `;

            userList.appendChild(userItem);

            // 添加按钮点击事件
            const button = userItem.querySelector('.enable-button');
            button.addEventListener('click', () => toggleEnable('user', user.userId, !user.enable));
        });
    }

    function toggleEnable(type, id, enable) {
    const url = type === 'poll' ? '/poll/enable' : '/user/enable';
    const data = type === 'poll' ? { pollId: id, enable } : { userId: id, enable };

    instance.put(url, data, {
        headers: {
            'Authorization': localStorage.getItem('jwt') || ''
        }
    })
    .then(response => {
        const data = response.data;
        if (data.code === 0) { // 检查是否成功
            console.log(`Successfully toggled ${type} enable status.`);
            // 更新UI中的按钮文本和颜色
            const button = document.querySelector(`.enable-button[data-id="${id}"]`);
            if (button) {
                button.textContent = enable ? 'Able' : 'Enable';
                button.className = button.className.replace(/btn-(danger|success)/, `btn-${enable ? 'secondary' : 'success'}`);
            }

            // 重新加载当前视图的数据
            const activeTab = document.querySelector('#dataTabs li.active a').getAttribute('href');
            if (activeTab === '#polls') {
                loadPollData(currentPagePolls, pageSize);
            } else if (activeTab === '#users') {
                loadUserData(currentPageUsers, pageSize);
            }
        } else {
            console.error('Toggle enable failed:', data.msg);
        }
    })
    .catch(error => console.error('Error:', error));
}

    function renderPagination(paginationId, currentPage, totalPages, loadDataFunction) {
        const paginationContainer = document.getElementById(paginationId);
        paginationContainer.innerHTML = ''; // 清空之前的分页控件

        if (totalPages <= 1) return;

        const ul = document.createElement('ul');
        ul.className = 'pagination';

        // 添加首页按钮
        const firstPageLi = createPaginationButton(1, 'First', () => loadDataFunction(1, pageSize));
        ul.appendChild(firstPageLi);

        // 添加上一页按钮
        const prevPageLi = createPaginationButton(currentPage - 1 > 0 ? currentPage - 1 : 1, 'Previous', () => loadDataFunction(currentPage - 1, pageSize));
        ul.appendChild(prevPageLi);

        // 添加页码按钮
        for (let i = 1; i <= totalPages; i++) {
            const isActive = i === currentPage;
            const pageLi = createPaginationButton(i, i.toString(), () => loadDataFunction(i, pageSize), isActive);
            ul.appendChild(pageLi);
        }

        // 添加下一页按钮
        const nextPageLi = createPaginationButton(currentPage + 1 <= totalPages ? currentPage + 1 : totalPages, 'Next', () => loadDataFunction(currentPage + 1, pageSize));
        ul.appendChild(nextPageLi);

        // 添加末页按钮
        const lastPageLi = createPaginationButton(totalPages, 'Last', () => loadDataFunction(totalPages, pageSize));
        ul.appendChild(lastPageLi);

        paginationContainer.appendChild(ul);
    }

    function createPaginationButton(page, text, onClick, isActive = false) {
        const li = document.createElement('li');
        li.className = `page-item ${isActive ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = text;
        a.addEventListener('click', (e) => {
            e.preventDefault();
            onClick();
        });
        li.appendChild(a);
        return li;
    }
})();
</script>

</body>

</html>